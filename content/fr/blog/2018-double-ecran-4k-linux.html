---
title: "Haute densit√© (HiDPI) avec deux √©crans 4K sous Linux"
description: |
  J'ai achet√© deux √©crans haute densit√© Dell P2415Q pour ma station
  de travail. Le support sous Linux avec X11 laisse toujours √† d√©sirer.
uuid: f7942543-be8a-4733-b897-cab011639e7f
cover: dual-dell-p2415q@2x.jpg
tags:
  - desktop
---

J'utilise un portable [Lenovo Thinkpad X1 Carbon][] (210¬†PPP) depuis
quatre ans ainsi qu'un t√©l√©phone [Nokia 8][] (550¬†PPP) depuis un an.
J'appr√©cie la haute densit√© de leurs √©crans respectifs : le rendu du
texte est excellent. Pour obtenir des r√©sultats similaires avec ma
station de travail, j'ai achet√© une paire d'√©crans [Dell P2415Q][] :

![Deux Dell P2415Q]([[!!images/dual-dell-p2415q@2x.jpg]] "Configuration en √©crans doubles avec deux moniteurs Dell P2415Q")

# √âcrans

Le *Dell P2415Q* est un √©cran 24" dot√© d'un panneau IPS d'une
r√©solution de 3840√ó2160 (185 PPP) et une couverture compl√®te de
l'espace de couleurs sRGB. Il est sorti en 2015 et son prix est
d√©sormais sous la barre des 400¬†‚Ç¨. Il a re√ßu des [critiques
positives][positive reviews].

L'une des unit√©s est arriv√© avec un pixel mort. Je pensais qu'il
s'agissait d'un probl√®me du pass√©, mais la [politique de Dell
concernant les pixels morts][Dell policy on dead pixels] stipule :

> Lors du processus de fabrication des √©crans LCD, un ou plusieurs
> pixels se figent parfois dans un √©tat immuable. Un √©cran comportant
> de 1 √† 5 sous-pixels fig√©s est consid√©r√© comme normal et conforme
> aux normes industrielles.

!!! "Mise √† jour (12.2018)" Trois nouveaux pixels morts sont apparus.
Aussi, je vous recommande d'√©viter ces √©crans.

Un deuxi√®me probl√®me est la pr√©sence de lignes grises horizontales
(difficilement) visibles sur fond blanc. Le probl√®me [ne semble pas
√™tre rare][not be uncommon], mais Dell est peu enthousiaste √† ce
sujet. Si je m'assois correctement, les lignes deviennent invisibles.

Je suis un peu d√©√ßu par ces aspects, mais je pense qu'ils restent
supportables et que c'est l'occasion de corriger mon obsession pour
ces d√©tails.

# Carte graphique

Pour piloter un √©cran 4K √† 60¬†Hz, il faut au moins un connecteur [HDMI
2.0][] ou [DisplayPort 1.2][]. Le *Dell P2415Q* a √©t√© [mis √† niveau
vers HDMI 2.0][upgraded to HDMI 2.0] en 2016 et dispose √©galement
d'une entr√©e DP¬†1.2. Il y a un port pour cha√Æner un second √©cran, mais
en l'absence de prise en charge de DP¬†1.3, le taux de rafra√Æchissement
tomberait √† 30¬†Hz.

Il n'y a actuellement aucune carte Radeon disponible autour de 100¬†‚Ç¨
et capable de piloter deux √©crans 4K. C√¥t√© Nvidia, la [GeForce GT
1030][] convient avec une consommation de 20 W pour la version GDDR4.
J'ai opt√© pour un [mod√®le √† refroidissement passif de MSI][passively
cooled model from MSI]. Sous Linux, le r√©sultat est assez d√©cevant :

 - Le [pilote *nouveau*][nouveau driver] n'a encore qu'une [prise en
   charge rudimentaire][rudimentary support] pour cette g√©n√©ration de
   puces Nvidia. Le r√©sultat est excessivement lent et le port
   HDMI¬†2.0 n'est pas g√©r√© correctement.

 - Le [pilote propri√©taire Nvidia en version 390][proprietary Nvidia
   driver version 390] pr√©sente des [probl√®mes de performance
   importants][important performance issues] qui le rendent
   inutilisable √† ces r√©solutions. Avec la [version 396][], la
   situation s'am√©liore, mais cela reste encore un peu poussif.
   J'utilise [Compton][] comme compositeur et j'ai pass√© [beaucoup de
   temps][a lot of time] √† essayer d'obtenir de meilleures
   performances en utilisant le backend OpenGL, sans succ√®s. J'utilise
   maintenant le backend *XRender*. Je dois aussi activer
   [l'utilisation d'OpenGL][OpenGL compositing] dans Firefox.[^video]
   <del>Je n'ai pas encore test√© la version 410.</del>

!!! "Mise √† jour (12.2018)" Les performances s'am√©liorent avec la
version 410, mais combin√©e avec Linux 4.19, la suspension en m√©moire
ne fonctionne plus.

[^video]: Sans ce param√®tre, il est impossible de lire une vid√©o HD ou
    4K dans Firefox. C'est un peu dommage que nous ne puissions
    toujours [pas obtenir un rendu vid√©o acc√©l√©r√© sous Linux][unable
    to get accelerated video rendering on Linux] alors que d'autres
    plates-formes ont cette fonctionnalit√© depuis longtemps. Pour
    Chromium, des [patchs existent][patches exist] mais ne sont pas
    accept√©s.

A l'avenir, je remplacerai peut-√™tre cette carte par une Radeon. Il
est difficile de d√©terminer si cela am√©liorera les
performances,[^perf] mais le pilote `amdgpu` sera certainement plus
stable et utilisable.

[^perf]: Par rapport √† ma configuration pr√©c√©dente, le nombre de
    pixels est quadrupl√©. La carte utilise 4 voies sur PCI 3.0, ce qui
    correspond √† une bande passante de 25 Gbits/s. Cela permet √† peine
    le transfert de 7680√ó2160 pixels √† 60 Hz en 24 bits. Ceci peut
    expliquer la difficult√© √† lire des vid√©os 4K sans acc√©l√©ration.

# Prise en charge de la haute densit√© avec X11

Gnome et KDE prennent d√©sormais en charge les affichages √† haute
densit√© (*HiDPI*) sans configuration particuli√®re sous X11. Pour les
autres environnements, le param√©trage est assez simple, gr√¢ce √†
[xsettingsd][]. Le code suivant doit √™tre invoqu√© √† partir de
`~/.xsession` ou lorsque la densit√© change :

    ::shell
    # Densit√© cible
    dpi=192

    # Pour les applications supportant XSettings, `Xft/DPI' indique
    # l'√©chelle pour les fontes (et parfois pour le reste de l'interface),
    # `Gdk/WindowScalingFactor' indique l'√©chelle pour l'interface avec
    # GTK 3 et `Gdk/UnscaledDPI' annule l'√©chelle choisie pour les fontes
    # pour les applications GTK 3.
    > ~/.xsettingsd cat <<EOF
    Xft/DPI $(( $dpi*1024 ))
    Gdk/WindowScalingFactor $(( $dpi/96 ))
    Gdk/UnscaledDPI $(( $dpi*1024/($dpi/96) ))
    EOF
    pkill -HUP xsettingsd || xsettingsd &

    # Pour les applications QT.
    export QT_AUTO_SCREEN_SCALE_FACTOR=1

    # Pour certaines autres applications.
    echo Xft.dpi: $dpi | xrdb -merge

Ensuite, c'est √† chaque application de savoir comment effectuer le
rendu √† la densit√© choisie. Le tableau ci-dessous donne un aper√ßu de
la prise en charge pour certaines d'entre elles, en utilisant les
param√®tres ci-dessus. ¬´¬†*√âchelle du texte*¬†¬ª indique si une
application est capable d'adapter la taille du texte. C'est
g√©n√©ralement la fonctionnalit√© la plus essentielle. ¬´¬†*√âchelle de
l'interface*¬†¬ª indique si elle est capable de mettre √† l'√©chelle
l'ensemble de l'interface, y compris les ic√¥nes. Id√©alement, les
applications devraient √©galement √™tre en mesure de changer
dynamiquement leurs param√®tres lorsqu'elles sont notifi√©es via
*XSettings*, ce qui est utile lors du passage sur un √©cran externe.

Application                   | √âchelle du texte | √âchelle de l'interface | Sans red√©marrage ?
--------------------          | ---------------- | ---------------------- | --------
Applications QT¬†5             | ‚úîÔ∏è            | ‚úîÔ∏è                 | ‚úîÔ∏è
Chromium[^chromium]           | ‚úîÔ∏è            | ‚úîÔ∏è                 | ‚úîÔ∏è
Applications Electron[^electron] | ‚úîÔ∏è            | ‚úîÔ∏è                 | ‚úîÔ∏è
Firefox                       | ‚úîÔ∏è            | ‚úîÔ∏è                 | ‚ùå
Blender[^blender]             | ‚úîÔ∏è            | ‚úîÔ∏è                 | ‚ùå
Emacs 26.1 (GTK¬†3)            | ‚úîÔ∏è            | üòê                 | ‚úîÔ∏è
[Terminaux VTE][vte] (GTK¬†3)  | ‚úîÔ∏è            | üòê                 | ‚úîÔ∏è
Applications GTK¬†3            | ‚úîÔ∏è            | üòê                 | ‚úîÔ∏è
Gimp (GTK¬†2)                  | ‚úîÔ∏è            | ‚ùå                 | ‚úîÔ∏è
Inkscape (GTK¬†2)              | ‚úîÔ∏è            | ‚ùå                 | ‚úîÔ∏è
Applications GTK¬†2            | ‚úîÔ∏è            | ‚ùå                 | ‚úîÔ∏è
Applications Java[^java]      | üôÑ            | üôÑ                 | ‚ùå
xterm and rxvt (avec Xft)     | ‚úîÔ∏è            | n/a               | ‚ùå
Autres applications           | ‚ùå            | ‚ùå                 | ‚ùå

[^chromium]: Pour d√©tecter les changements, *Chromium* surveille les
    √©v√®nements *RandR*. Ils peuvent √™tre captur√©s avant d'avoir pu
    mettre √† jour les variables *XSettings*.

[^electron]: Si cela ne fonctionne pas, essayez avec le drapeau
    `--force-device-scale-factor=2`.

[^blender]: *Blender* se base sur la valeur de la ressource `Xft.dpi`.

[^java]: Les applications Java doivent √™tre invoqu√©es avec la variable
    d'environnement `GDK_SCALE=2`, sans quoi, aucune mise √† l'√©chelle
    n'est effectu√©e.

Les applications **QT¬†5** offrent une excellente prise en charge. Les
applications **GTK¬†3** ne peuvent utiliser qu'un coefficient
multiplicateur entier pour mettre √† l'√©chelle leurs interfaces, ce qui
est ennuyeux quand on a besoin d'un facteur 1.5√ó. Les applications
**GTK¬†2** ne savent adapter que la taille du texte. Elles sont
toujours assez nombreuses, avec notamment *Gimp*. Pour plus de
d√©tails, jetez un ≈ìil sur la page d√©di√©e au sujet sur [ArchWiki][].
Au-del√† de X11, [Wayland][] permet d'utiliser une densit√© diff√©rente
pour chaque √©cran et de mettre √† l'√©chelle les applications qui ne
savent pas prendre en charge les densit√©s √©lev√©es.

En conclusion, la situation actuelle d√©pend √©norm√©ment des
applications utilis√©es. Mes principales applications √©tant Firefox,
Emacs et un terminal bas√© sur VTE, le r√©sultat me satisfait.

*[PPP]: Pixels par pouce
*[IPS]: In-Plane Switching

[Lenovo Thinkpad X1 Carbon]: https://www.thinkwiki.org/wiki/Category:X1_Carbon_2nd "ThinkPad X1 Carbon 2nd on ThinkWiki"
[Nokia 8]: https://en.wikipedia.org/wiki/Nokia_8 "Nokia 8 on Wikipedia"
[Dell P2415Q]: https://www.dell.com/en-us/shop/dell-24-ultra-hd-4k-monitor-p2415q/apd/210-agnk/monitors-monitor-accessories "Dell 24 Ultra HD 4K Monitor"
[positive reviews]: https://pcmonitors.info/reviews/dell-p2415q/ "Dell P2415Q on PC Monitors"
[Dell policy on dead pixels]: https://www.dell.com/support/article/us/en/19/sln130145/dell-lcd-display-pixel-guidelines?lang=fr "Instructions relatives aux pixels des √©crans LCD de Dell"
[not be uncommon]: https://www.dell.com/community/Desktops-General-Read-Only/P2415Q-faint-horizontal-grey-lines/td-p/5135894 "P2415Q, faint horizontal grey lines"
[HDMI 2.0]: https://en.wikipedia.org/wiki/HDMI#Refresh_frequency_limits_for_standard_video "HDMI: Refresh frequency limits for standard video"
[DisplayPort 1.2]: https://en.wikipedia.org/wiki/DisplayPort#Resolution_and_refresh_frequency_limits "DisplayPort: Refresh frequency limits"
[upgraded to HDMI 2.0]: https://www.dell.com/support/article/us/en/19/sln306595/setting-up-the-p2415q-p2715q-monitors-with-hdmi-20-that-support-4k-x-2k-60hz?lang=en "Setting Up the P2415Q / P2715Q Monitors with HDMI 2.0 that Support 4K x 2K 60Hz"
[GeForce GT 1030]: https://www.geforce.com/hardware/desktop-gpus/geforce-gt-1030/specifications "GeForce GT 1030 specifications"
[passively cooled model from MSI]: https://www.msi.com/Graphics-card/GeForce-GT-1030-2GHD4-LP-OC "MSI GeForce GT 1030 2GHD4 LP OC"
[nouveau driver]: https://nouveau.freedesktop.org "Nouveau: Accelerated Open Source driver for Nvidia cards"
[rudimentary support]: https://archive.is/2018/https://nouveau.freedesktop.org/wiki/FeatureMatrix/ "Feature matrix for the nouveau driver"
[important performance issues]: https://devtalk.nvidia.com/default/topic/1029484/linux/-various-all-distros-numerous-performance-amp-rendering-issues-on-390-25 "Numerous Performance & Rendering Issues on 390.25"
[Compton]: https://github.com/chjj/compton/ "A compositor for X11"
[OpenGL compositing]: https://wiki.archlinux.org/index.php/Firefox/Tweaks#Enable_OpenGL_Off-Main-Thread_Compositing_.28OMTC.29 "Firefox performance tweaks"
[patches exist]: https://chromium-review.googlesource.com/c/chromium/src/+/532294 "Chromium: Enable VAVDA, VAVEA and VAJDA on linux with VAAPI only"
[unable to get accelerated video rendering on Linux]: https://bugzilla.mozilla.org/show_bug.cgi?id=1210727 "Add VA-API hardware decoding support on Linux"
[xsettingsd]: https://github.com/derat/xsettingsd "Provides settings to X11 applications via the XSETTINGS specification"
[vte]: [[fr/blog/2017-ecrire-emulateur-terminal.html]] "√âcrire son propre √©mulateur de terminal"
[ArchWiki]: https://wiki.archlinux.org/index.php/HiDPI "HiDPI on ArchWiki"
[Wayland]: https://wayland.freedesktop.org/ "Wayland"
[a lot of time]: https://github.com/vincentbernat/awesome-configuration/commits/c7a3a44b378d6cca8de09b005d0200bc629e6796/xsession
[proprietary Nvidia driver version 390]: http://archive.is/CNvOT "nvidia-driver (390.87-2) in Debian Buster"
[version 396]: http://archive.is/mQRz8 "nvidia-driver (396.54-1)"

{# Local Variables:      #}
{# mode: markdown        #}
{# indent-tabs-mode: nil #}
{# End:                  #}
