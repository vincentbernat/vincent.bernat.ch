---
title: "Git comme source de v√©rit√© pour l'automatisation du r√©seau"
description: |
  NetBox est souvent la solution de r√©f√©rence comme source de v√©rit√© pour
  l'automatisation du r√©seau. Utiliser Git √† la place pr√©sente plusieurs avantages. üéÉ
uuid: ab9964eb-f08c-438a-af52-ba70bc51976b
tags:
  - network-automation
---

La premi√®re √©tape pour automatiser un r√©seau consiste √† cr√©er la
**source de v√©rit√©**. Il s'agit d'un r√©f√©rentiel de donn√©es qui
d√©crit l'√©tat attendu : la liste des p√©riph√©riques, les adresses
IP, les param√®tres des protocoles r√©seau, les serveurs de temps, etc.
Un choix populaire est [NetBox][]. Sa documentation souligne son
utilisation comme source de v√©rit√© :

> *NetBox* vise √† repr√©senter l'√©tat souhait√© d'un r√©seau par rapport
> √† son √©tat op√©rationnel. En tant que tel, l'importation automatis√©e
> de l'√©tat actuel du r√©seau est fortement d√©conseill√©e. Toutes les
> donn√©es cr√©√©es dans *NetBox* doivent d'abord √™tre v√©rifi√©es par un
> humain afin de garantir leur int√©grit√©. *NetBox* peut ensuite √™tre
> utilis√© pour alimenter les syst√®mes de surveillance et
> d'installation avec un haut degr√© de confiance.

Lors de la pr√©sentation de [Jerikan][], un retour fr√©quent que nous
avons re√ßu √©tait : ¬´ vous devriez utiliser *NetBox* pour √ßa ¬ª. En
effet, la source de v√©rit√© de *Jerikan* est un [ensemble de fichiers
YAML][bunch of YAML files] versionn√©s avec *Git*.

# Pourquoi Git ?

Si nous examinons la fa√ßon dont les choses sont faites dans le monde
syst√®me, dans un centre de donn√©es ou dans les nuages, nous trouvons
des utilisateurs de [Terraform][], un outil transformant des fichiers
de configuration d√©claratifs en infrastructure. Les outils de gestion
de configuration d√©clarative comme [Salt][], [Puppet][][^wikimedia] ou
[Ansible][] se chargent de la configuration des serveurs. [NixOS][]
est une alternative : il combine la gestion des paquets et la gestion
de configuration avec un langage fonctionnel pour construire des
machines virtuelles et des conteneurs. Lorsqu'on utilise un cluster
Kubernetes, on trouve [Kustomize][] ou [Helm][], deux autres outils
d√©claratifs de gestion de configuration. Utilis√©s ensemble, ces outils
mettent en ≈ìuvre le paradigme de l'*infrastructure en tant que code*.

[^wikimedia]: Wikimedia g√®re son infrastructure √† l'aide de *Puppet*.
    Ils publient l'ensemble sur [GitHub][wikimedia]. Creative Commons
    utilise *Salt*. Ils publient √©galement sur
    [GitHub][creativecommons]. Merci √† eux ! J'aurais souhait√© pouvoir
    √©num√©rer des exemples suppl√©mentaires mais peu d'√©quipes publient
    leur infrastructure.

> L'*infrastructure en tant que code* est une approche de
> l'automatisation des infrastructures bas√©e sur les pratiques du
> d√©veloppement logiciel. Elle met l'accent sur des routines
> coh√©rentes et reproductibles pour l'installation et la modification
> des syst√®mes et de leur configuration. Vous apportez des
> modifications au code, puis utilisez l'automatisation pour tester et
> appliquer ces modifications √† vos syst√®mes.
>
> ‚Äï Kief Morris, [Infrastructure as Code][], O'Reilly.

Un syst√®me de contr√¥le de version est un outil central pour
l'infrastructure en tant que code. Le candidat habituel est *Git* avec
un syst√®me de gestion du code source comme [GitLab][] ou [GitHub][].
Vous obtenez :


Tra√ßabilit√© et visibilit√©
: Git conserve un journal de toutes les modifications : quoi, qui,
  pourquoi et quand. Avec un peu de discipline, chaque changement est
  expliqu√© et autonome. Il devient une partie de la documentation
  de l'infrastructure. Lorsque l'√©quipe de support se plaint d'une
  d√©gradation de l'exp√©rience de certains clients au cours des deux
  derniers mois, vous d√©couvrez rapidement que cela peut √™tre li√© √†
  une modification d'une politique de routage √† New York.

Revenir en arri√®re
: Si un changement est d√©fectueux, il peut √™tre annul√© sans effort
  rapidement et en toute s√©curit√©, m√™me si d'autres changements sont
  intervenus entre-temps. Le changement de politique √† l'origine du
  probl√®me s'√©tend sur trois routeurs. L'annulation de celui-ci et le
  d√©ploiement de la configuration vous permettent de r√©soudre la
  situation en attendant une meilleure solution.

Branches et revue de code
: En travaillant sur une nouvelle fonctionnalit√© ou en remaniant une
  partie de l'infrastructure, une membre de l'√©quipe cr√©e une branche
  et travaille sur son changement sans interf√©rer avec le travail des
  autres membres. Une fois la branche pr√™te, une demande de revue est
  cr√©√©e et les autres membres de l'√©quipe peuvent l'examiner avant de
  l'accepter. Vous d√©couvrez que le probl√®me √©tait li√© √† la d√©viation
  du trafic √† travers un IX o√π un FAI √©tait connect√© via un lien de
  trop faible capacit√©. Vous proposez et discutez d'un correctif qui
  inclut un changement du sch√©ma et des mod√®les utilis√©s pour d√©clarer
  les politiques de routage afin de pouvoir g√©rer ce cas.

Int√©gration continue
: Pour chaque changement, des tests automatis√©s sont d√©clench√©s. Ils
  peuvent d√©tecter les probl√®mes et donner plus de d√©tails sur l'effet
  d'un changement. Chaque branche peut √™tre d√©ploy√©es dans une
  infrastructure virtuelle o√π des tests de r√©gression sont ex√©cut√©s.
  Les r√©sultats peuvent √™tre synth√©tis√©s sous forme de commentaire
  pour la revue de code. Vous v√©rifiez que le changement que vous
  proposez ne modifie pas les autres politiques existantes.

# Pourquoi pas NetBox ?

*NetBox* ne partage pas ces caract√©ristiques. Il s'agit d'une base de
donn√©es avec une API REST et GraphQL. La tra√ßabilit√© est limit√©e : les
modifications ne sont pas regroup√©es dans une transaction et elles ne
sont pas document√©es. Vous ne pouvez pas cr√©er de branches sur la base
de donn√©es. En g√©n√©ral, il existe une seule base de donn√©es de test.
Cela limite le travail sur plusieurs fonctionnalit√©s. La r√©plication
des modifications sur la base de production peut √™tre hazardeux. Le
retour en arri√®re n'est pas trivial.[^gitdb]

[^gitdb]: [Dolt][] et [TerminusDB][] sont deux moteurs de base de
    donn√©es SQL permettant de cr√©er des branches, comme un d√©p√¥t Git.
    *Dolt* est compatible avec les clients *MySQL*. Ils pourraient
    faire partie d'une solution pour mettre une source de v√©rit√© dans
    une base de donn√©es. J'ignore ce qu'il en est des performances
    d'une telle base.

De plus, *NetBox* n'est g√©n√©ralement pas la seule source de v√©rit√©. Il
contient votre inventaire mat√©riel, les adresses IP et quelques
informations sur la topologie. Cependant, ce n'est pas l'endroit o√π
vous mettez les cl√©s SSH, les serveurs de temps ou la configuration
BGP. Si vous utilisez √©galement [Ansible][], ces informations
aboutissent dans l'inventaire. La source de v√©rit√© est donc fragment√©e
entre plusieurs outils avec des flux de travail diff√©rents. Depuis
*NetBox* 2.7, vous pouvez attacher des donn√©es arbitraire gr√¢ce aux
[contextes de configuration][configuration contexts]. Cela mitige ce
point. Les donn√©es sont organis√©es de mani√®re hi√©rarchique mais cette
hi√©rarchie ne peut pas √™tre personnalis√©e[^custom]. [Nautobot][], un
fork de *NetBox*, peut g√©rer les contextes de configuration dans un
d√©p√¥t *Git*, tout en permettant d'utiliser l'API pour les consulter.
Vous b√©n√©ficiez des avantages de *Git* mais les donn√©es restantes sont
toujours dans une base de donn√©es avec un cycle de vie diff√©rent.

[^custom]: La possibilit√© de personnaliser la hi√©rarchie est
    essentielle pour √©viter les r√©p√©titions dans les donn√©es. Par
    exemple, si des routeurs travaillent par paire, certaines donn√©es
    doivent √™tre attach√©es au groupe et non dupliqu√©es
    sur chacun d'eux. Les √©tiquettes peuvent √™tre utilis√©es pour
    contourner partiellement ce probl√®me, mais vous perdez l'aspect
    hi√©rarchique.

Enfin, le sch√©ma utilis√© par *NetBox* peut ne pas correspondre √† vos
besoins et vous ne pouvez pas le modifier. Par exemple, vous pouvez
avoir une r√®gle pour calculer l'adresse IPv6 √† partir de l'adresse
IPv4 pour les interfaces avec les deux familles. Une telle relation ne
peut pas √™tre facilement exprim√©e et appliqu√©e dans *NetBox*. Lorsque
vous changez l'adresse IPv4, vous pouvez oublier de mettre √† jour
l'adresse IPv6. La source de v√©rit√© ne devrait contenir que l'adresse
IPv4 mais vous voulez aussi l'adresse IPv6 dans *NetBox* car c'est votre
IPAM et vous en avez besoin pour mettre √† jour vos entr√©es DNS.

# Pourquoi pas Git ?

Il y a quelques limitations lorsque vous placez votre source de v√©rit√© dans *Git* :

1. Si vous souhaitez exposer une interface web pour permettre √† une
   √©quipe externe de demander une modification, il est plus difficile
   de le faire avec *Git* qu'avec une base de donn√©es. *NetBox*
   dispose d'une interface web et d'un syst√®me de gestion des
   permissions. Vous pouvez √©galement √©crire votre propre interface
   web et interagir avec *NetBox* via son API.

2. Les fichiers YAML sont plus difficiles √† interroger de diff√©rentes
   mani√®res. Par exemple, la recherche d'une adresse IP libre est
   complexe si elles sont dispers√©es √† plusieurs endroits.

√Ä mon avis, dans la plupart des cas, il est pr√©f√©rable de placer la
source de v√©rit√© dans *Git* plut√¥t que dans *NetBox*. Vous obtenez
beaucoup d'avantages et vous pouvez toujours utiliser *NetBox* comme
une vue en lecture seule qui peut ensuite √™tre utilis√©e par d'autres
outils. Nous faisons cela avec un [module Ansible][Ansible module].
Dans les autres cas, *Git* peut toujours faire l'affaire. Le contr√¥le
d'acc√®s en lecture seule peut √™tre effectu√© par le biais de
sous-modules. Les demandes de revue peuvent restreindre l'acc√®s en
√©criture : un robot peut v√©rifier que les changements ne modifient que
les fichiers autoris√©s. Cela n√©cessite quelques connaissances de
*Git*, mais de nombreuses √©quipes sont maintenant √† l'aise avec lui,
gr√¢ce √† son omnipr√©sence.

*[REST]: Representational state transfer
*[API]: Application Programming Interface
*[IPAM]: IP address management
*[FAI]: Fournisseur d'acc√®s √† Internet
*[IX]: Internet Exchange
[NetBox]: https://netbox.readthedocs.io/en/stable/ "NetBox documentation"
[Jerikan]: [[fr/blog/2021-reseau-jerikan-ansible.html]] "Jerikan+Ansible : un syst√®me de gestion de configuration pour le r√©seau"
[Ansible]: https://www.ansible.com/
[Terraform]: https://www.terraform.io/
[Salt]: https://saltproject.io/
[Puppet]: https://puppet.com/
[Kustomize]: https://kustomize.io/ "Kubernetes native configuration management"
[Helm]: https://helm.sh/ "The package manager for Kubernetes"
[Infrastructure as Code]: https://infrastructure-as-code.com/book/ "Infrastructure as Code book by Kief Morris"
[wikimedia]: https://github.com/wikimedia/puppet "Wikimedia Puppet repository on GitHub"
[creativecommons]: https://github.com/creativecommons/sre-salt-prime "Creative Common Salt repository on GitHub"
[GitLab]: https://about.gitlab.com
[GitHub]: https://github.com
[Dolt]: https://github.com/dolthub/dolt
[TerminusDB]: https://github.com/terminusdb/terminusdb
[configuration contexts]: https://netbox.readthedocs.io/en/stable/models/extras/configcontext/
[Ansible module]: [[en/blog/2020-syncing-netbox-ansible.html]] "Syncing NetBox with a custom Ansible module"
[Nautobot]: https://nautobot.readthedocs.io/en/latest/ "open source Network Source of Truth and Network Automation Platform"
[NixOS]: https://nixos.org/
[bunch of YAML files]: https://github.com/jerikan-network/cmdb/tree/main/data
