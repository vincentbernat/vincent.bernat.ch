---
title: "Cr√©ation de chemins d'AS infinis dans BGP"
description: |
   En combinant deux fonctionnalit√©s √† √©viter, il est possible
   de cr√©er une boucle BGP qui g√©n√®re un chemin d'AS sans limite.
uuid: 684f47ec-70eb-4651-a964-da3fcac29f28
tags:
  - network-bgp
attachments:
  "https://github.com/vincentbernat/network-lab/tree/master/lab-bgp-infinite-aspath": "D√©p√¥t Git"
---

La combinaison des [conf√©d√©rations BGP][rfc3065] et du [remplacement d'AS][AS
override] peut potentiellement cr√©er une boucle de routage BGP, r√©sultant en un
chemin d'AS qui grossit ind√©finiment.

La **conf√©d√©ration BGP** est une technique utilis√©e pour r√©duire le nombre de
sessions iBGP et am√©liorer le passage √† l'√©chelle dans les grands syst√®mes
autonomes (AS). Elle divise un AS en sous-AS. La plupart des r√®gles eBGP
s'appliquent entre les sous-AS, sauf que le saut suivant, la MED et les
pr√©f√©rences locales restent inchang√©s. La longueur du chemin d'AS ignore les
contributions des sous-AS de la conf√©d√©ration. La conf√©d√©ration BGP est rarement
utilis√©e et la [r√©flexion des routes BGP][rfc4456] lui est g√©n√©ralement
pr√©f√©r√©e.

Le **remplacement d'AS** est une fonctionnalit√© qui permet √† un routeur de
remplacer l'ASN d'un voisin dans le chemin d'AS des routes BGP sortantes par le
sien. C'est utile lorsque deux syst√®mes autonomes distincts partagent le m√™me
ASN. Cependant, cela interf√®re avec le m√©canisme de pr√©vention des boucles de
BGP et doit √™tre utilis√© avec prudence. Une alternative plus s√ªre est la
directive `allowas-in`[^allowconfedas-in].

[^allowconfedas-in]: Lors de l'utilisation des conf√©d√©rations BGP avec Cisco IOS
    XR, utilisez `allowconfedas-in` √† la place. C'est disponible depuis [IOS XR
    7.11][].

Dans l'exemple ci-dessous, nous avons quatre routeurs dans une seule
conf√©d√©ration, chacun dans son propre sous-AS. `R0` est √† l'origine du pr√©fixe
`2001:db8::1/128`. `R1`, `R2`, et `R3` transmettent ce pr√©fixe au routeur
suivant dans la boucle.

![Boucle de routage BGP impliquant 4 routeurs : R0 est √† l'origine du pr√©fixe,
R1, R2 et R3 le font tourner en boucle en utilisant next-hop-self et
as-override]([[!!images/bgp-loop.svg]] "Boucle de routage BGP utilisant une
conf√©d√©ration")

Les configurations des routeurs sont disponibles dans un [d√©p√¥t Git][git
repository]. Ils tournent sous Cisco IOS XR. `R2` utilise la configuration BGP
suivante :

```cisco hl_lines="21 22 23"
router bgp 64502
 bgp confederation peers
  64500
  64501
  64503
 !
 bgp confederation identifier 64496
 bgp router-id 1.0.0.2
 address-family ipv6 unicast
 !
 neighbor 2001:db8::2:0
  remote-as 64501
  description R1
  address-family ipv6 unicast
  !
 !
 neighbor 2001:db8::3:1
  remote-as 64503
  advertisement-interval 0
  description R3
  address-family ipv6 unicast
   next-hop-self
   as-override
  !
 !
!
```

La session avec `R3` utilise √† la fois les directives `as-override` et
`next-hop-self`. Cette derni√®re est seulement n√©cessaire pour rendre le pr√©fixe
annonc√© valide, car il n'y a pas d'IGP dans cet exemple[^igp].

[^igp]: L'utilisation des conf√©d√©rations BGP est d√©j√† une mauvaise id√©e. Si en
    plus vous n'utilisez pas le m√™me IGP pour tous les sous-AS, vous vous
    exposez √† bien des probl√®mes ! Toutefois, le sc√©nario expos√© ici est aussi
    possible avec un IGP.

Voici la s√©quence d'√©v√©nements menant √† un chemin d'AS infini :

1. `R0` envoie le pr√©fixe √† `R1` avec le chemin d'AS `(64500)`[^confed].

1. `R1` le s√©lectionne comme meilleur chemin et le transmet √† `R2` avec le
   chemin d'AS `(64501 64500)`.

1. `R2` le s√©lectionne comme meilleur chemin et le transmet √† `R3` avec le
   chemin d'AS `(64502 64501 64500)`.

1. `R3` le s√©lectionne comme meilleur chemin. Il devrait le transmettre √† `R1`
   avec le chemin d'AS `(64503 64502 64501 64500)`, mais en raison du
   remplacement d'AS, il substitue l'ASN de `R1` par le sien, le transmettant
   avec le chemin d'AS `(64503 64502 64503 64500)`.

1. `R1` accepte le pr√©fixe, car son propre ASN n'est pas dans le chemin d'AS. Il
   compare ce nouveau pr√©fixe avec celui de `R0`. `(64500)` et `(64503 64502
   64503 64500)` ont la m√™me longueur car les sous-AS de la conf√©d√©ration ne
   contribuent pas √† la longueur du chemin d'AS. **Le premier crit√®re pour
   d√©partager les deux routes est alors l'ID du routeur**. L'ID du routeur de
   `R0` (`1.0.0.4`) est plus √©lev√© que celui de `R3` (`1.0.0.3`). Le nouveau
   pr√©fixe devient le meilleur chemin et est transmis √† `R2` avec le chemin d'AS
   `(64501 64503 64501 64503 64500)`.

1. `R2` re√ßoit le nouveau pr√©fixe, rempla√ßant l'ancien. Il le s√©lectionne comme
   meilleur chemin et le transmet √† `R3` avec le chemin d'AS `(64502 64501 64502
   64501 64502 64500)`.

1. `R3` re√ßoit le nouveau pr√©fixe, rempla√ßant l'ancien. Il le s√©lectionne comme
   meilleur chemin et le transmet √† `R0` avec le chemin d'AS `(64503 64502 64503
   64502 64503 64502 64500)`.

1. `R1` re√ßoit le nouveau pr√©fixe, rempla√ßant l'ancien. Encore une fois, il est
   en concurrence avec le pr√©fixe de `R0`, et encore une fois le nouveau pr√©fixe
   gagne en raison de l'ID de routeur inf√©rieur. Le pr√©fixe est transmis √† `R2`
   avec le chemin d'AS `(64501 64503 64501 64503 64501 64503 64501 64500)`.

[^confed]: Lorsqu'un segment de chemin d'AS est compos√© d'ASN d'une
    conf√©d√©ration, il est repr√©sent√© entre parenth√®ses.

Quelques it√©rations plus tard, `R1` voit le pr√©fixe en boucle comme suit[^pacing] :

```console hl_lines="11"
RP/0/RP0/CPU0:R1#show bgp ipv6 u 2001:db8::1/128 bestpath-compare
BGP routing table entry for 2001:db8::1/128
Last Modified: Jul 28 10:23:05.560 for 00:00:00
Paths: (2 available, best #2)
  Path #1: Received by speaker 0
  Not advertised to any peer
  (64500)
    2001:db8::1:0 from 2001:db8::1:0 (1.0.0.4), if-handle 0x00000000
      Origin IGP, metric 0, localpref 100, valid, confed-external
      Received Path ID 0, Local Path ID 0, version 0
      Higher router ID than best path (path #2)
  Path #2: Received by speaker 0
  Advertised IPv6 Unicast paths to peers (in unique update groups):
    2001:db8::2:1
  (64503 64502 64503 64502 64503 64502 64503 64502 64503 64502 64503 64502 64503 64502 64503 64502 64503 64502 64503 64502 64503 64502 64503 64502 64503 64502 64503 64502 64503 64502 64503 64502 64503 64502 64503 64502 64503 64502 64503 64502 64503 64502 64503 64502 64503 64502 64503 64502 64503 64502 64503 64502 64503 64502 64503 64502 64503 64502 64503 64502 64503 64502 64503 64502 64503 64502 64503 64502 64503 64502 64503 64502 64503 64502 64503 64502 64503 64502 64503 64502 64503 64502 64503 64502 64503 64502 64503 64502 64503 64502 64503 64502 64503 64502 64503 64502 64503 64502 64503 64502 64503 64502 64500)
    2001:db8::4:0 from 2001:db8::4:0 (1.0.0.3), if-handle 0x00000000
      Origin IGP, metric 0, localpref 100, valid, confed-external, best, group-best
      Received Path ID 0, Local Path ID 1, version 37
      best of AS 64503, Overall best
```

[^pacing]: Par d√©faut, IOS XR ralentit les mises √† jour eBGP. Ceci est contr√¥l√©
    par la directive `advertisement-interval`. Sa valeur par d√©faut est de 30
    secondes pour les sessions eBGP (y compris dans les conf√©d√©rations). `R1` et
    `R2` passent cette valeur √† 0, tandis que `R3` la d√©finit √† 2 secondes. Cela
    donne un peu de temps pour observer la croissance du chemin d'AS.

Il n'y a pas de limite sup√©rieure pour un chemin d'AS, mais les messages BGP ont
des limites de taille (4096 octets selon [RFC 4271][rfc4271] ou 65535 octets
selon [RFC 8654][rfc8654]). Pass√© un certain nombre d'it√©rations, les mises √†
jour BGP ne peuvent plus √™tre g√©n√©r√©es. Sur Cisco IOS XR, le processus BGP
plante bien avant d'atteindre cette limite. üòë

---

Les principales le√ßons de cette histoire sont de n'utiliser en aucune
circonstance les conf√©d√©rations BGP et d'√™tre prudent avec les fonctionnalit√©s
qui affaiblissent la d√©tection de boucles de routage BGP.

*[BGP]: Border Gateway Protocol
*[iBGP]: Internal BGP
*[eBGP]: External BGP
*[IGP]: Internal Gateway Protocol
*[AS]: Autonomous System
*[ASN]: Autonomous System Number
*[ASNs]: Autonomous System Numbers
*[MED]: Multi-Exit Discriminator

[rfc3065]: rfc://3065 "RFC 3065: Autonomous System Confederations for BGP"
[rfc4456]: rfc://4456 "RFC 4456: BGP Route Reflection: An Alternative to Full Mesh Internal BGP (IBGP)"
[rfc4271]: rfc://4271 "RFC 4271: A Border Gateway Protocol 4 (BGP-4)"
[rfc8654]: rfc://8654 "RFC 8654: Extended Message Support for BGP"
[as override]: https://networklessons.com/bgp/mpls-layer-3-vpn-bgp-override "MPLS Layer 3 VPN BGP AS Override"
[ios xr 7.11]: https://www.cisco.com/c/en/us/td/docs/iosxr/ncs5500/bgp/711x/configuration/guide/b-bgp-cg-ncs5500-711x/implementing-bgp.html#feat-3439-overview-bgp-allowas-in-9k
[git repository]: https://github.com/vincentbernat/network-lab/tree/master/lab-bgp-infinite-aspath
