---
title: "OPL2LPT : une carte son AdLib sur port parall√®le"
description: |
  L'OPL2LPT est une carte son √©quip√©e d'une puce OPL2 (telle que celle de
  l'AdLib) et fontionnant sur port parall√®le. Elle peut √©galement √™tre
  utilis√©e sous Linux.
uuid: 374e2888-56e7-4f74-b75f-9c1b65f26cad
cover: opl2lpt@2x.jpg
tags:
  - retro
---

La [carte son AdLib][AdLib sound cards] √©tait la premi√®re carte son en
vogue pour les IBM PC (avant cela, nous √©tions choy√©s par le son du
haut-parleur interne). Connect√©e √† un slot ISA 8 bits, elle est
√©quip√©e d'une puce [Yamaha YM3812][], aussi connue sous le nom
d'*OPL2*. Cette puce peut piloter 9 canaux sonores dont les
caract√©ristiques sont affin√©es gr√¢ce √† 244 registres.

![Carte son AdLib]([[!!images/adlib-board.jpg]] "Une carte son AdLib. La puce OPL2 se situe dans le coin inf√©rieur gauche. <a href='https://commons.wikimedia.org/wiki/File:Adlib.jpg'>CC-BY-SA-2.5</a>.")

J'en avais une mais je l'ai √©gar√©e. Les mod√®les disponibles sur eBay
sont assez rares et chers. Il est possible d'en fabriquer une soi-m√™me
(soit [celle de Sergey][Sergey's one], soit cette [reproduction
fid√®le][faithful reproduction]). Cependant, un port ISA est toujours
n√©cessaire. L'imagination d√©bordante de certains passionn√©s peut
encore aider ici. Par exemple, vous pouvez combiner la [carte
processeur Xi 8088 de Sergey][Sergey's Xi 8088 processor board] avec
son [fond de panier ISA 8 bits][ISA 8-bit backplane], sa [carte Super
VGA][ISA Super VGA card] et sa [carte XT-CF-Lite][XT-CF-Lite card]
pour obtenir votre propre PC compatible IBM vaguement moderne. Vous
pouvez √©galement jeter un ≈ìil sur la [carte son AdLib sur un port
parall√®le][AdLib sound card on a parallel port] de Rapha√´l Ass√©nat.

# La carte son OPL2LPT

R√©cemment, [David Murray][8-Bit Guy] a publi√© une vid√©o sur une [carte
son AdLib pour port parall√®le][AdLib sound card for the parallel
port], l'[OPL2LPT][]. Bien que les cartes m√®res actuelles n'aient plus
de port parall√®le, il est facile d'en ajouter un au [format
PCI-Express][PCI-Express one]. J'ai donc achet√© une *OPL2LPT*
pr√©-assembl√©e et quelques jours plus tard, elle √©tait dans ma bo√Æte
√† lait¬†:

![Carte son OPL2LPT]([[!!images/opl2lpt@2x.jpg]] "La carte son OPL2LPT sur une bo√Æte du jeu ¬´¬†Day of the Tentacle¬†¬ª pour indiquer l'√©chelle.")

!!! "Mise √† jour (03.2018)" Vous pouvez √©galement acheter un
[bo√Ætier][3D-printed enclosure] pour l'*OPL2LPT*. Apr√®s avoir √©crit
cet article, on m'en a offert un:

![Bo√Ætier pour l'OPL2LPT]([[!!images/opl2lpt-case@2x.jpg]] "La carte son OPL2LPT dans son bo√Ætier imprim√© en 3D, pos√© sur une bo√Æte du jeu ¬´¬†Monkey Island 4¬†¬ª.")

!!! "Mise √† jour (07.2018)" L'[OPL3LPT][] est √©galement disponible
avec une conception similaire mais utilisant une puce OPL3.

Tel que con√ßu, ce p√©riph√©rique se branche sur un port parall√®le ISA
(accessible √† l'adresse 0x378). Il faut ensuite charger un [pilote
pour DOS][DOS driver] (qui va intercepter les appels vers l'adresse de
la carte AdLib) puis ex√©cuter un jeu compatible avec l'AdLib. Bien
qu'il soit correctement pris en charge par Linux, le port parall√®le
PCI-Express ne fonctionne pas comme son √©quivalent ISA. [QEMU][] est
livr√© avec une √©mulation du port parall√®le mais, en raison de
[probl√®mes de synchronisation][timing issues], ne peut pas piloter
correctement l'*OPL2LPT*. Par contre, l'√©mulation de [VirtualBox][]
est suffisante[^vbox].

[^vbox]: Il n'y a pas d'interface graphique pour configurer le port
    parall√®le. Cela doit se faire via la ligne de commande :
    
        ::console
        $ VBoxManage modifyvm "FreeDOS (games)" --lptmode1 /dev/parport0
        $ VBoxManage modifyvm "FreeDOS (games)" --lpt1 0x378 7

Sous Linux, l'*OPL2LPT* se programme presque comme une [v√©ritable
AdLib][prog]. Le bout de code ci-dessous permet d'√©crire une valeur
dans un des registres :

    ::c
    static void lpt_write(uint8_t data, uint8_t ctrl) {
      ieee1284_write_data(port, data);
      ieee1284_write_control(port, (ctrl | C1284_NINIT) ^ C1284_INVERTED);
      ieee1284_write_control(port,  ctrl                ^ C1284_INVERTED);
      ieee1284_write_control(port, (ctrl | C1284_NINIT) ^ C1284_INVERTED);
    }
    
    void opl_write(uint8_t reg, uint8_t value) {
      lpt_write(reg, C1284_NSELECTIN | C1284_NSTROBE);
      usleep(4); // 3.3 microseconds
    
      lpt_write(value, C1284_NSELECTIN);
      usleep(23);
    }

Pour utiliser ¬´¬†nativement¬†¬ª l'*OPL2LPT*, j'ai modifi√© les programmes
suivants :

 - [ScummVM][], un √©mulateur pour d'anciens jeux d'aventure, notamment
   ceux de Lucas¬≠Arts ‚Äî [patch][scummvm-patch][^scummvm]
 - [QEMU][], un √©mulateur g√©n√©rique et rapide ‚Äî [patch][qemu-patch]
   avec une √©mulation minimaliste des minuteries et les temporisations
   cod√©es en dur üôÑ
 - [DOSBox][], un √©mulateur x86 int√©grant DOS ‚Äî [patch][dosbox-patch]
   avec une √©mulation compl√®te des minuteries et un fil d'ex√©cution
   d√©di√©[^delays]

[^scummvm]: Le patch pour *ScummVM* a √©t√© accept√©. La prise en charge
    de l'*OPL2LPT* appara√Ætra avec la version 2.1. √Ä la compilation,
    l'option `--enable-opl2lpt` doit √™tre sp√©cifi√©e.

[^delays]: Avec *QEMU* et *DOSBox*, le respect des d√©lais n√©cessaires
    au bon fonctionnement de l'OPL2 devrait √™tre la responsabilit√© du
    jeu qui s'ex√©cute. Toutefois, *QEMU* n'√©mule pas les d√©lais dus
    aux entr√©es/sorties et *DOSBox* <del>semble ne pas √™tre assez
    pr√©cis</del> <ins>travaille sur des intervalles de 1
    milliseconde</ins>. Sur ce dernier, l'*OPL2LPT* est g√©r√©e depuis
    un fil d'ex√©cution d√©di√© qui re√ßoit les √©critures et s'assure que
    les d√©lais minimaux sont respect√©s.

Vous pouvez comparer les r√©sultats sur l'introduction du jeu [Indiana
Jones et la derni√®re croisade][Indiana Jones and the Last Crusade]
dans la vid√©o suivante[^nostalgia]¬†:

![]([[!!videos/2018-adlib-opl2lpt-1-indy3.m3u8]])

 - [0:00](#video-seek-0), **DOSBox** avec une √©mulation du **haut-parleur interne**
 - [0:58](#video-seek-58), **DOSBox** avec une √©mulation de l'**AdLib**
 - [1:51](#video-seek-111), **VirtualBox** avec l'**OPL2LPT** (sur un port parall√®le √©mul√©)
 - [2:42](#video-seek-162), **ScummVM** modifi√© avec l'**OPL2LPT**
 - [3:33](#video-seek-213), **QEMU** modifi√© avec l'**OPL2LPT**
 - [4:24](#video-seek-264), **DOSBox** modifi√© avec l'**OPL2LPT**
 - [5:17](#video-seek-317), **DOSBox** modifi√© avec une version am√©lior√©e de l'**√©mulateur OPL3** ([Nuked OPL3][])
 - [6:10](#video-seek-370), **ScummVM** avec la **piste CD** (version [FM Towns][])

[^nostalgia]: *Indiana Jones et la derni√®re croisade* a √©t√© le premier
    jeu que j'ai essay√© apr√®s avoir branch√© la carte son AdLib que
    j'ai forc√© mes parents √† acheter lors d'un voyage au Canada
    en 1992. √Ä l'√©poque, aucun magasin traditionnel ne vendait cette
    carte dans ma ville fran√ßaise et les achats en ligne (via le
    [Minitel][]) √©taient limit√©s aux biens de grande consommation
    (comme un magn√©toscope). La grande √©poque. üòè
    
    La vid√©o illustre la version VGA
    (320√ó200, 256 couleurs) publi√©e en 1990. Toutefois, √† l'√©poque, je
    jouais avec la version CGA/EGA (320√ó200, 4 couleurs fixes ou
    640√ó350, 16 couleurs issues d'une palette de 64).

Je vous laisse juger de la qualit√© de chaque option ! Vous pouvez vous
procurer <del>l'*OPL2LPT*</del> l'*OPL3LPT* depuis l'Europe via
[Serdashop][OPL3LPT] ou depuis l'Am√©rique du Nord via [The 8-Bit
Guy][OPL3LPT-US].

# Annexes

## Indiana Jones et le myst√®re de l'Atlantide

Voici une autre vid√©o avec l'introduction de [Indiana Jones et le
myst√®re de l'Atlantide][Indiana Jones and the Fate of Atlantis],
publi√© en 1992, tournant dans *DOSBox* avec l'*OPL2LPT*. C'est le
second jeu utilisant le syst√®me de son [iMUSE][] : la musique est
synchronis√©e avec l'action et les transitions se font en toute
transparence. Particuli√®rement novateur pour l'√©poque !

![]([[!!videos/2018-adlib-opl2lpt-2-indy4.m3u8]])

## Monkey Island 2

Le premier jeu utilisant *iMuse* est [Monkey Island 2][], publi√©
en 1991. La vid√©o ci-dessous montre les premi√®res minutes du jeu
tournant dans *DOSBox* avec l'*OPL2LPT*.

![]([[!!videos/2018-adlib-opl2lpt-3-monkey2.m3u8]])

Notamment, √† [5:33](#video-seek-333), quand Guybrush se trouve √†
Woodtick, une sympathique ville de Scabb Island, la musique joue
autour d'un th√®me principal et d'une variation avec un instrument
diff√©rent pour chaque b√¢timent, sans jamais s'interrompre.

## Enregistrement des vid√©os

Avec une carte vid√©o VGA, de nombreux jeux utilisent le [Mode 13h][],
un mode 256 couleurs avec une r√©solution de 320√ó200. Sur un √©cran 4:3,
ce mode n'affiche pas de pixels carr√©s: ils sont √©tir√©s verticalement
par un facteur de 1,2.

Les vid√©os pr√©c√©dentes ont √©t√© enregistr√©es avec [FFmpeg][] (puis
√©dit√©es avec [Blender][]). Il propose de tr√®s [nombreux
filtres][useful filters] permettant d'automatiser la capture et une
partie du montage. Voici un exemple :

    ::shell
    FONT="font=Monkey Island 1991 refined:
          fontcolor=OrangeRed:
          fontsize=16:
          x=w-text_w-10"
    ffmpeg -y \
      -thread_queue_size 64 \
      -f x11grab -draw_mouse 0 -r 30 -s 640x400 -i :0+844,102 \
      -thread_queue_size 64 \
      -f pulse -ac 1 -i default \
      -filter_complex "[0:v]pad=854:400:0:0,
           drawtext=${FONT}:y= 10:text=Indiana Jones 3,
           drawtext=${FONT}:y= 34:text=Intro,
           drawtext=${FONT}:y=100:text=DOSBox,
           drawtext=${FONT}:y=124:text=VGA,
           drawtext=${FONT}:y=148:text=PC speaker,
           scale=854:480:flags=neighbor[game];
           [1:a]volumedetect;
           [1:a]showwaves=s=214x100:colors=OrangeRed:scale=lin[waves];
           [1:a]showcqt=s=214x100[spectrum];
           [waves][spectrum]vstack[vis];
           [game][vis]overlay=x=640:y=280" \
      -pix_fmt yuv420p -c:v libx264 -qp 0 -preset ultrafast \
      indy3-dosbox-pcspkr.mkv

La partie int√©ressante est l'argument `filter_complex`. La vid√©o
captur√©e passe du format 640√ó400 au format 854√ó400 sans √©tirement
comme premi√®re √©tape d'adaptation au format 16:9[^blur]. En utilisant
la fonte *[The Secret Font of Monkey Island][sfomi]*, du texte est
ajout√© sur la droite de la vid√©o. Le r√©sultat est ensuite √©tir√© vers
du 854√ó480 pour obtenir le format final. Le flux vid√©o correspondant
est nomm√© `game`. Dans un deuxi√®me temps, la piste audio est utilis√©e
pour construire deux visualisations : une vue d'oscilloscope et un
spectrogramme. Elles sont plac√©es verticalement et le r√©sultat est
nomm√© `vis`. La derni√®re √©tape est de superposer les deux flux
pr√©c√©dents.

[^blur]: Une m√©thode courante pour √©tendre une vid√©o de 4:3 √† 16:9
    sans barres noires est d'ajouter en fond la vid√©o √©tir√©e et
    flout√©e. C'est aussi [possible avec FFmpeg][so-blurred]¬†!

[AdLib sound cards]: https://en.wikipedia.org/wiki/Ad_Lib,_Inc.#AdLib_Music_Synthesizer_Card_(1987) "AdLib Music Synthesizer Card sur Wikipedia"
[Yamaha YM3812]: https://en.wikipedia.org/wiki/Yamaha_YM3812 "Yamaha YM3812 sur Wikipedia"
[8-Bit Guy]: http://www.the8bitguy.com/ "The 8-Bit Guy"
[informative video about the OPL2]: https://www.youtube.com/watch?v=QLJSdNYcdpk "The 8-Bit Guy: Meet the little-known Soundblaster Keyboards"
[AdLib sound card for the parallel port]: https://www.youtube.com/watch?v=z3DU2mNBa6M "The 8-Bit Guy: Ad-Lib Sound Card for the Parallel Port"
[Sergey's one]: http://www.malinov.com/Home/sergeys-projects/isa-opl2-card "ISA OPL2 Card"
[faithful reproduction]: http://tubetime.us/index.php/2016/07/22/a-reproduction-adlib-sound-card/ "A Reproduction AdLib Sound Card"
[Sergey's Xi 8088 processor board]: http://www.malinov.com/Home/sergeys-projects/xi-8088 "Sergey's projects: Xi 8088"
[ISA 8-bit backplane]: https://github.com/skiselev/isa8_backplane "Sergey's projects: ISA 8-bit backplane"
[ISA Super VGA card]: http://www.malinov.com/Home/sergeys-projects/isa-supervga "Sergey's projects: ISA Super VGA"
[XT-CF-Lite card]: http://www.malinov.com/Home/sergeys-projects/xt-cf-lite "Sergey's projects: XT-CF-Lite v4"
[AdLib sound card on a parallel port]: https://www.raphnet.net/electronique/adlib/adlib_en.php "AdLib sound card on a parallel port"
[OPL2LPT]: https://www.serdashop.com/OPL2LPT "OPL2LPT sur Serdashop"
[OPL3LPT]: https://www.serdashop.com/OPL3LPT "OPL3LPT sur Serdashop"
[OPL3LPT-US]: http://www.the8bitguy.com/product/opl3lpt-ad-lib-compatible-parallel-sound-card/ "OPL3LPT via The 8-bit Guy"
[3D-printed enclosure]: https://www.serdashop.com/OPL2LPTENCLOSURE "OPL2LPT enclosure on Serdashop"
[PCI-Express one]: https://www.amazon.fr/dp/B00YE0QATW/ "SIENOC PCI (PCI-E TO RS232+DB25 Adapter) sur Amazon"
[DOS driver]: https://github.com/pdewacht/adlipt/tree/master/adlipt "ADLiPT: pilote DOS pour l'OPL2LPT"
[QEMU]: https://www.qemu.org/ "QEMU: generic and open source machine emulator and virtualizer"
[timing issues]: https://github.com/pdewacht/adlipt/issues/3 "OPL2LPT: Not working with QEMU parallel port emulation"
[VirtualBox]: https://www.virtualbox.org/ "Oracle VM VirtualBox"
[prog]: http://shipbrook.net/jeff/sb.html "Programming the AdLib/Sound Blaster FM Music Chips"
[opl2test]: https://github.com/pdewacht/adlipt/tree/master/opl2test "OPL2TEST: programme de test autonome"
[opl2test-patch]: https://github.com/pdewacht/adlipt/pull/4 "opl2test: adapt for Linux"
[ScummVM]: https://www.scummvm.org/ "ScummVM"
[scummvm-patch]: https://github.com/scummvm/scummvm/pull/1137 "AUDIO: add support for OPL2LPT"
[qemu-patch]: https://patchwork.ozlabs.org/patch/874876/ "[RFC,v1] hw/audio/opl2lpt: add support for OPL2LPT"
[DOSBox]: https://www.dosbox.com/ "DOSBox, an x86 emulator with DOS"
[dosbox-patch]: https://github.com/vincentbernat/dosbox/compare/feature/opl2lpt "Add OPL2LPT support"
[Indiana Jones and the Last Crusade]: https://fr.wikipedia.org/wiki/Indiana_Jones_et_la_Derni%C3%A8re_Croisade_(jeu_vid%C3%A9o) "Indiana Jones et la Derni√®re Croisade (jeu vid√©o) sur Wikipedia"
[FM Towns]: https://en.wikipedia.org/wiki/FM_Towns "FM Towns sur Wikipedia"
[Nuked OPL3]: https://sourceforge.net/p/dosbox/patches/270/ "Nuked OPL3 patch for DOSBox"
[Minitel]: https://fr.wikipedia.org/wiki/Minitel "Minitel sur Wikipedia"
[Mode 13h]: https://fr.wikipedia.org/wiki/Mode_13h "Mode 13h sur Wikipedia"
[FFmpeg]: https://ffmpeg.org/ "FFmpeg: cross-platform solution to record, convert and stream audio and video"
[useful filters]: https://ffmpeg.org/ffmpeg-filters.html "FFmpeg Filters Documentation"
[ffmpeg-pad]: https://ffmpeg.org/ffmpeg-filters.html#pad-1 "FFmpeg pad filter"
[ffmpeg-drawtext]: https://ffmpeg.org/ffmpeg-filters.html#drawtext "FFmpeg drawtext filter"
[ffmpeg-asplit]: https://ffmpeg.org/ffmpeg-filters.html#asplit "FFmpeg asplit filter"
[ffmpeg-showwaves]: https://ffmpeg.org/ffmpeg-filters.html#showwaves "FFmpeg showwaves filter"
[ffmpeg-showcqt]: https://ffmpeg.org/ffmpeg-filters.html#showcqt "FFmpeg showcqt filter"
[ffmpeg-vstack]: https://ffmpeg.org/ffmpeg-filters.html#vstack "FFmpeg vstack filter"
[ffmpeg-overlay]: https://ffmpeg.org/ffmpeg-filters.html#overlay "FFmpeg overlay filter"
[ffmpeg-scale]: https://ffmpeg.org/ffmpeg-filters.html#scale "FFmpeg scale filter"
[so-blurred]: https://stackoverflow.com/questions/30789367/ffmpeg-how-to-convert-vertical-video-with-black-sides-to-video-169-with-blur "Stack Overflow: FFmpeg: How to convert vertical video with black sides, to video 16:9, with blurred background sides"
[sfomi]: https://www.ptless.org/sfomi/ "The Secret Font of Monkey Island"
[Blender]: https://www.blender.org/ "Free and Open 3D creation software"
[Indiana Jones and the Fate of Atlantis]: https://fr.wikipedia.org/wiki/Indiana_Jones_et_le_Myst%C3%A8re_de_l%27Atlantide "Indiana Jones et le myst√®re de l'Atlantide sur Wikipedia"
[iMUSE]: https://fr.wikipedia.org/wiki/Interactive_Music_Streaming_Engine "iMUSE sur Wikipedia"
[Monkey Island 2]: https://fr.wikipedia.org/wiki/Monkey_Island_2:_LeChuck%27s_Revenge "Monkey Island 2: LeChuck's Revenge sur Wikipedia"

{# Local Variables:      #}
{# mode: markdown        #}
{# indent-tabs-mode: nil #}
{# End:                  #}
